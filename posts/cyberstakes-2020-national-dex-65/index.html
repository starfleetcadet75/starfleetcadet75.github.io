<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8" />
<meta name="author" content="" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.76.2" />

<link rel="canonical" href="https://starfleetcadet75.github.io/posts/cyberstakes-2020-national-dex-65/">
<meta property="og:title" content="Cyberstakes CTF 2020: National Dex #65" />
<meta property="og:description" content="We found the encryptor but it won&rsquo;t decrypt encrypted?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starfleetcadet75.github.io/posts/cyberstakes-2020-national-dex-65/" />
<meta property="article:published_time" content="2020-05-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-03T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cyberstakes CTF 2020: National Dex #65"/>
<meta name="twitter:description" content="We found the encryptor but it won&rsquo;t decrypt encrypted?"/>


<meta itemprop="name" content="Cyberstakes CTF 2020: National Dex #65">
<meta itemprop="description" content="We found the encryptor but it won&rsquo;t decrypt encrypted?">
<meta itemprop="datePublished" content="2020-05-03T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-05-03T00:00:00+00:00" />
<meta itemprop="wordCount" content="278">



<meta itemprop="keywords" content="reversing,crypto," />


<link rel="stylesheet" href="/css/layout.css" />


<link rel="stylesheet" href="/css/default-dark.css" />


<link rel="stylesheet" href="/css/adoc-html5-extension.css" />



<title>


     Cyberstakes CTF 2020: National Dex #65 

</title>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://starfleetcadet75.github.io/">starfleetcadet75</a>
    </div> 

    
    
    <a class="nav-item" href="/about/"><div class="nav-item-title">About</div></a>
    
    <a class="nav-item" href="/readinglist/"><div class="nav-item-title">Reading List</div></a>
    
    <a class="nav-item active" href="/posts/"><div class="nav-item-title">Posts</div></a>
    

  </nav>

  
<div class="social-links-header" style="visibility:hidden; display:none;">

  
  <a href="mailto:starfleetcadet75@gmail.com"><div class="social-link">email</div></a>
  

  
  <a href="https://github.com/starfleetcadet75" target="_blank"><div class="social-link">gh</div></a>
  

  
  <a href="https://gitlab.com/starfleetcadet75" target="_blank"><div class="social-link">gl</div></a>
  

  

  

</div>


</div>


</header>


<article class="post">
    <h1 class="title"> Cyberstakes CTF 2020: National Dex #65 </h1>
    <div class="content"> <p><strong>Category:</strong> Reverse Engineering<br>
<strong>Points:</strong> 100</p>
<h2 id="challenge">Challenge</h2>
<blockquote>
<p>We found the <a href="https://github.com/starfleetcadet75/writeups/raw/master/2020-Cyberstakes/national-dex-65/encrypt">encryptor</a> but it won&rsquo;t decrypt <a href="https://github.com/starfleetcadet75/writeups/raw/master/2020-Cyberstakes/national-dex-65/encrypted">encrypted</a>?</p>
</blockquote>
<h4 id="hints">Hints</h4>
<ul>
<li>I think they&rsquo;re using a cipher designed by Bruce Schneier.</li>
<li>When reversing, it&rsquo;s useful to look for magic constants or use a tool like findcrypt (idapython version or Ghidra version).</li>
<li>Make sure you&rsquo;re using CBC mode.</li>
</ul>
<h2 id="observations">Observations</h2>
<p>Most modern encryption functions use identifiable constant values, usually to initialize their state before performing an operation.
<a href="https://github.com/d3v1l401/FindCrypt-Ghidra">FindCrypt</a> uses a database of these constants to scan programs for their occurrence.
Running it on the <code>encrypt</code> program in Ghidra, we are shown the following results:</p>
<p><img src="https://raw.githubusercontent.com/starfleetcadet75/writeups/master/2020-Cyberstakes/national-dex-65/findcrypt.png" alt="findcrypt"></p>
<p>Bruce Schneier is the creator of Blowfish, so the results seem to confirm that this is the cipher in use.
The <code>bf_init</code> array at 0x493a60 is used in a function called <code>BF_set_key</code> so we navigate there.</p>
<p><img src="https://raw.githubusercontent.com/starfleetcadet75/writeups/master/2020-Cyberstakes/national-dex-65/bfsetkey.png" alt="bfsetkey"></p>
<p>We can see where the S and P boxes of the Blowfish cipher are created.
The key itself is probably passed in as an argument to this function from somewhere else.
Following the cross references takes us to the following location:</p>
<p><img src="https://raw.githubusercontent.com/starfleetcadet75/writeups/master/2020-Cyberstakes/national-dex-65/bf_key.png" alt="bf_key"></p>
<p>We can see that an array called <code>GLOBAL2</code> is used as an argument to the <code>BF_set_key</code> function.
This is the constant key value that the program uses to perform encryption but we still need to find the IV value.
If we look a little further below the <code>GLOBAL2</code> array, we notice another array called <code>GLOBAL1</code> which looks like a good candidate.</p>
<h2 id="solution">Solution</h2>
<p>We can write a short decryptor script using <a href="https://www.pycryptodome.org/en/latest/">PyCryptodome</a> and copy the arrays from Ghidra.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> Crypto.Cipher <span style="color:#f92672">import</span> Blowfish

bs <span style="color:#f92672">=</span> Blowfish<span style="color:#f92672">.</span>block_size
iv <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x71\x3a\xf2\x9a\x59\x36\x0b\xe4</span><span style="color:#e6db74">&#39;</span>
key <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xb0\x23\xc0\x4d\xcc\x55\x32\x41\xf6\x8a\xb3\xf7\x66\x91\x0c\x26</span><span style="color:#e6db74">&#39;</span>
ciphertext <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xd5\x35\x8e\xdd\x59\x3b\x4f\xe4\x13\x9b\x81\xde\xf6\xb7\xd7\x97\xd3\x93\x59\x9d\xc9\xa5\x46\x21\xde\x1c\xaa\xc9\x08\x26\x35\xf2</span><span style="color:#e6db74">&#39;</span>

cipher <span style="color:#f92672">=</span> Blowfish<span style="color:#f92672">.</span>new(key, Blowfish<span style="color:#f92672">.</span>MODE_CBC, iv)
msg <span style="color:#f92672">=</span> cipher<span style="color:#f92672">.</span>decrypt(ciphertext)
<span style="color:#66d9ef">print</span>(msg)
</code></pre></div><p><strong>Flag:</strong> <code>ACI{7845061bac2563882068e7f7061}</code></p>
 </div>
    <footer class="post-footer">

  <div class="post-footer-data">
            
<div class="tags">
  
    
      <div class="tag">
        <a href="/tags/reversing">#reversing</a>
      </div>
    
      <div class="tag">
        <a href="/tags/crypto">#crypto</a>
      </div>
    
  
</div>

    <div class="post-footer-meta">Permalink: <a href="https://starfleetcadet75.github.io/posts/cyberstakes-2020-national-dex-65/">/posts/cyberstakes-2020-national-dex-65/</a> | Date: 2020-05-03 </div>
    
    <hr>
            
<div class="categories">
  
  Published in:
    
      <div class="category">
        <a href="/categories/writeups">writeups</a>
      </div>
    
  
</div>

            
<div class="series">
  
</div>

    
  </div>
</footer>



</article>

  <footer>

  <div class="social-links-footer">

  
  <a href="mailto:starfleetcadet75@gmail.com"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/starfleetcadet75" target="_blank"><div class="social-link">GitHub</div></a>
  

  
  <a href="https://gitlab.com/starfleetcadet75" target="_blank"><div class="social-link">GitLab</div></a>
  

  

  

  <div class="social-link">
  <a href="https://starfleetcadet75.github.io/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright">  </div>

  <div class="poweredby">
    Powered by <a href="https://gohugo.io/">Hugo</a>.
  </div>

  </footer>

</div> 

</body>
</html>

