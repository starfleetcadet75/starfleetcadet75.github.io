<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=author content><meta name=description content><meta name=keywords content><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><meta name=generator content="Hugo 0.99.1"><link rel=canonical href=https://starfleetcadet75.github.io/posts/flareon-2020-6-codeit/><meta property="og:title" content="Flare-On CTF 2020 Challenge 6: codeit"><meta property="og:description" content="Reverse engineer this little compiled script to figure out what you need to do to make it give you the flag (as a QR code)."><meta property="og:type" content="article"><meta property="og:url" content="https://starfleetcadet75.github.io/posts/flareon-2020-6-codeit/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-23T00:00:00+00:00"><meta property="article:modified_time" content="2020-09-23T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Flare-On CTF 2020 Challenge 6: codeit"><meta name=twitter:description content="Reverse engineer this little compiled script to figure out what you need to do to make it give you the flag (as a QR code)."><meta itemprop=name content="Flare-On CTF 2020 Challenge 6: codeit"><meta itemprop=description content="Reverse engineer this little compiled script to figure out what you need to do to make it give you the flag (as a QR code)."><meta itemprop=datePublished content="2020-09-23T00:00:00+00:00"><meta itemprop=dateModified content="2020-09-23T00:00:00+00:00"><meta itemprop=wordCount content="1547"><meta itemprop=keywords content="reversing,forensics,"><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=/css/default-dark.css><link rel=stylesheet href=/css/adoc-html5-extension.css><title>Flare-On CTF 2020 Challenge 6: codeit</title></head><body><div class=main><header><div class=header-bar><nav><div class=siteTitle><a href=https://starfleetcadet75.github.io/>starfleetcadet75</a></div><a class=nav-item href=/about/><div class=nav-item-title>About</div></a><a class=nav-item href=/readinglist/><div class=nav-item-title>Reading List</div></a><a class="nav-item active" href=/posts/><div class=nav-item-title>Posts</div></a></nav><div class=social-links-header style=visibility:hidden;display:none><a href=mailto:starfleetcadet75@gmail.com><div class=social-link>email</div></a><a href=https://github.com/starfleetcadet75 target=_blank><div class=social-link>gh</div></a><a href=https://gitlab.com/starfleetcadet75 target=_blank><div class=social-link>gl</div></a></div></div></header><article class=post><h1 class=title>Flare-On CTF 2020 Challenge 6: codeit</h1><div class=content><h2 id=challenge>Challenge</h2><blockquote><p>Reverse engineer this little compiled script to figure out what you need to do to make it give you the flag (as a QR code).</p></blockquote><h2 id=observations>Observations</h2><p>We are provided with a UPX-packed executable that prompts us to enter text to be encoded as a QR code.</p><p><img src=https://raw.githubusercontent.com/starfleetcadet75/writeups/master/2020-Flareon-CTF/codeit/prompt.PNG alt=prompt></p><h2 id=extracting-the-script>Extracting the Script</h2><p>Loading the unpacked program into Binary Ninja, we can see that it is pretty large.
Fortunately, the string &ldquo;This is a third-party compiled AutoIt script&rdquo; immediately indicates we do not have to continue looking at the assembly.
<a href=https://www.autoitscript.com/site/autoit/>AutoIt</a> is a freeware scripting language for automating Windows GUI interaction that can be compiled into a runnable executable.</p><p>We can use the AutoIt Extractor tool that is provided by default inside Flare VM to extract the original AutoIt script.</p><p><img src=https://raw.githubusercontent.com/starfleetcadet75/writeups/master/2020-Flareon-CTF/codeit/exe2aut.png alt=exe2aut></p><p>The script can be found <a href=https://github.com/starfleetcadet75/writeups/blob/master/2020-Flareon-CTF/codeit/codeit.au3>here</a>.</p><h2 id=reversing-the-script>Reversing the Script</h2><p>The script is lightly obfuscated with many of the function and variable names having been changed to junk values.
At the end of the script there is a global variable named <code>$os</code> that contains an array of hex string values that are decoded by the last function.
Whenever <code>$os[$somenum]</code> is called, the script gets the unobfuscated string value from the encoded array.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>decode</span>(enc):
</span></span><span style=display:flex><span>    out <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(enc), <span style=color:#ae81ff>2</span>):
</span></span><span style=display:flex><span>        out <span style=color:#f92672>+=</span> chr(int(enc[i: i <span style=color:#f92672>+</span> <span style=color:#ae81ff>2</span>], <span style=color:#ae81ff>16</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> out
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;7374727563743b75696e7420626653697a653b75696e7420626652657365727665643b75696e742062664f6666426974733b&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;75696e7420626953697a653b696e7420626957696474683b696e742062694865696768743b7573686f7274206269506c616e&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;65733b7573686f7274206269426974436f756e743b75696e74206269436f6d7072657373696f6e3b75696e7420626953697a&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;65496d6167653b696e742062695850656c735065724d657465723b696e742062695950656c735065724d657465723b75696e&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;74206269436c72557365643b75696e74206269436c72496d706f7274616e743b656e647374727563743b4FD5$626653697a6&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;54FD5$626652657365727665644FD5$62664f6666426974734FD5$626953697a654FD5$626957696474684FD5$6269486569&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;6768744FD5$6269506c616e65734FD5$6269426974436f756e744FD5$6269436f6d7072657373696f6e4FD5$626953697a65&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;496d6167654FD5$62695850656c735065724d657465724FD5$62695950656c735065724d657465724FD5$6269436c7255736&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;5644FD5$6269436c72496d706f7274616e744FD5$7374727563743b4FD5$627974655b4FD5$5d3b4FD5$656e647374727563&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;744FD5$4FD5$2e626d704FD5$5c4FD5$2e646c6c4FD5$7374727563743b64776f72643b636861725b313032345d3b656e647&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;374727563744FD5$6b65726e656c33322e646c6c4FD5$696e744FD5$476574436f6d70757465724e616d65414FD5$7074724&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;FD5$436f6465497420506c7573214FD5$7374727563743b627974655b4FD5$5d3b656e647374727563744FD5$73747275637&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;43b627974655b35345d3b627974655b4FD5$7374727563743b7074723b7074723b64776f72643b627974655b33325d3b656e&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;647374727563744FD5$61647661706933322e646c6c4FD5$437279707441637175697265436f6e74657874414FD5$64776f7&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;2644FD5$4372797074437265617465486173684FD5$437279707448617368446174614FD5$7374727563742a4FD5$4372797&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;07447657448617368506172616d4FD5$30784FD5$30383032304FD5$30303031304FD5$36363030304FD5$30323030304FD5&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;$303030304FD5$43443442334FD5$32433635304FD5$43463231424FD5$44413138344FD5$44383931334FD5$45364639324&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;FD5$30413337414FD5$34463339364FD5$33373336434FD5$30343243344FD5$35394541304FD5$37423739454FD5$413434&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;33464FD5$46443138394FD5$38424145344FD5$39423131354FD5$46364342314FD5$45324137434FD5$31414233434FD5$3&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;4433235364FD5$31324135314FD5$39303335464FD5$31384642334FD5$42313735324FD5$38423341454FD5$43414633444&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;FD5$34383045394FD5$38424638414FD5$36333544414FD5$46393734454FD5$30303133354FD5$33354432334FD5$314534&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;42374FD5$35423243334FD5$38423830344FD5$43374145344FD5$44323636414FD5$33374233364FD5$46324335354FD5$3&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;5424633414FD5$39454136414FD5$35384243384FD5$46393036434FD5$43363635454FD5$41453243454FD5$36304632434&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;FD5$44453338464FD5$44333032364FD5$39434334434FD5$45354242304FD5$39303437324FD5$46463942444FD5$323646&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;39314FD5$31394238434FD5$34383446454FD5$36394542394FD5$33344634334FD5$46454544454FD5$44434542414FD5$3&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;7393134364FD5$30383139464FD5$42323146314FD5$30463833324FD5$42324135444FD5$34443737324FD5$44423132434&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;FD5$33424544394FD5$34374636464FD5$37303641454FD5$34343131414FD5$35324FD5$7374727563743b7074723b70747&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;23b64776f72643b627974655b383139325d3b627974655b4FD5$5d3b64776f72643b656e647374727563744FD5$437279707&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;4496d706f72744b65794FD5$4372797074446563727970744FD5$464c4152454FD5$4552414c464FD5$43727970744465737&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;4726f794b65794FD5$437279707452656c65617365436f6e746578744FD5$437279707444657374726f79486173684FD5$73&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;74727563743b7074723b7074723b64776f72643b627974655b31365d3b656e647374727563744FD5$7374727563743b64776&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;f72643b64776f72643b64776f72643b64776f72643b64776f72643b627974655b3132385d3b656e647374727563744FD5$47&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;657456657273696f6e4578414FD5$456e746572207465787420746f20656e636f64654FD5$43616e2068617a20636f64653f&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;4FD5$4FD5$48656c704FD5$41626f757420436f6465497420506c7573214FD5$7374727563743b64776f72643b64776f7264&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;3b627974655b333931385d3b656e647374727563744FD5$696e743a636465636c4FD5$6a75737447656e6572617465515253&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;796d626f6c4FD5$7374724FD5$6a757374436f6e76657274515253796d626f6c546f4269746d6170506978656c734FD5$546&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;869732070726f6772616d2067656e65726174657320515220636f646573207573696e6720515220436f64652047656e65726&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;1746f72202868747470733a2f2f7777772e6e6179756b692e696f2f706167652f71722d636f64652d67656e657261746f722&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;d6c6962726172792920646576656c6f706564206279204e6179756b692e204FD5$515220436f64652047656e657261746f72&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;20697320617661696c61626c65206f6e20476974487562202868747470733a2f2f6769746875622e636f6d2f6e6179756b69&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;2f51522d436f64652d67656e657261746f722920616e64206f70656e2d736f757263656420756e6465722074686520666f6c&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;6c6f77696e67207065726d697373697665204d4954204c6963656e7365202868747470733a2f2f6769746875622e636f6d2f&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;6e6179756b692f51522d436f64652d67656e657261746f72236c6963656e7365293a4FD5$436f7079726967687420c2a9203&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;23032302050726f6a656374204e6179756b692e20284d4954204c6963656e7365294FD5$68747470733a2f2f7777772e6e61&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;79756b692e696f2f706167652f71722d636f64652d67656e657261746f722d6c6962726172794FD5$5065726d697373696f6&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;e20697320686572656279206772616e7465642c2066726565206f66206368617267652c20746f20616e7920706572736f6e2&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;06f627461696e696e67206120636f7079206f66207468697320736f66747761726520616e64206173736f636961746564206&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;46f63756d656e746174696f6e2066696c6573202874686520536f667477617265292c20746f206465616c20696e207468652&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;0536f66747761726520776974686f7574207265737472696374696f6e2c20696e636c7564696e6720776974686f7574206c6&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;96d69746174696f6e207468652072696768747320746f207573652c20636f70792c206d6f646966792c206d657267652c207&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;075626c6973682c20646973747269627574652c207375626c6963656e73652c20616e642f6f722073656c6c20636f7069657&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;3206f662074686520536f6674776172652c20616e6420746f207065726d697420706572736f6e7320746f2077686f6d20746&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;86520536f667477617265206973206675726e697368656420746f20646f20736f2c207375626a65637420746f20746865206&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;66f6c6c6f77696e6720636f6e646974696f6e733a4FD5$312e205468652061626f766520636f70797269676874206e6f7469&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;636520616e642074686973207065726d697373696f6e206e6f74696365207368616c6c20626520696e636c7564656420696e&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;20616c6c20636f70696573206f72207375627374616e7469616c20706f7274696f6e73206f662074686520536f6674776172&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;652e4FD5$322e2054686520536f6674776172652069732070726f76696465642061732069732c20776974686f75742077617&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;272616e7479206f6620616e79206b696e642c2065787072657373206f7220696d706c6965642c20696e636c7564696e67206&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;27574206e6f74206c696d6974656420746f207468652077617272616e74696573206f66206d65726368616e746162696c697&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;4792c206669746e65737320666f72206120706172746963756c617220707572706f736520616e64206e6f6e696e6672696e6&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;7656d656e742e20496e206e6f206576656e74207368616c6c2074686520617574686f7273206f7220636f707972696768742&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;0686f6c64657273206265206c6961626c6520666f7220616e7920636c61696d2c2064616d61676573206f72206f746865722&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;06c696162696c6974792c207768657468657220696e20616e20616374696f6e206f6620636f6e74726163742c20746f72742&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;06f72206f74686572776973652c2061726973696e672066726f6d2c206f7574206f66206f7220696e20636f6e6e656374696&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;f6e20776974682074686520536f667477617265206f722074686520757365206f72206f74686572206465616c696e6773206&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;96e2074686520536f6674776172652e4FD5$7374727563743b7573686f72743b656e647374727563744FD5$7374727563743&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;b627974653b627974653b627974653b656e647374727563744FD5$43726561746546696c654FD5$75696e744FD5$53657446&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;696c65506f696e7465724FD5$6c6f6e674FD5$577269746546696c654FD5$7374727563743b64776f72643b656e647374727&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;563744FD5$5265616446696c654FD5$436c6f736548616e646c654FD5$44656c65746546696c65414FD5$47657446696c655&#34;</span>
</span></span><span style=display:flex><span>dlit <span style=color:#f92672>+=</span> <span style=color:#e6db74>&#34;3697a65&#34;</span>
</span></span><span style=display:flex><span>os <span style=color:#f92672>=</span> dlit<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#34;4FD5$&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(len(os)):
</span></span><span style=display:flex><span>    print(str(i <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;: &#34;</span> <span style=color:#f92672>+</span> decode(os[i]))
</span></span></code></pre></div><p>The unobfuscated strings, with indexing starting at 1, are included below:</p><pre tabindex=0><code class=language-none data-lang=none>1: struct;uint bfSize;uint bfReserved;uint bfOffBits;uint biSize;int biWidth;int biHeight;ushort biPlanes;ushort biBitCount;uint biCompression;uint biSizeImage;int biXPelsPerMeter;int biYPelsPerMeter;uint biClrUsed;uint biClrImportant;endstruct;
2: bfSize
3: bfReserved
4: bfOffBits
5: biSize
6: biWidth
7: biHeight
8: biPlanes
9: biBitCount
10: biCompression
11: biSizeImage
12: biXPelsPerMeter
13: biYPelsPerMeter
14: biClrUsed
15: biClrImportant
16: struct;
17: byte[
18: ];
19: endstruct
20:
21: .bmp
22: \
23: .dll
24: struct;dword;char[1024];endstruct
25: kernel32.dll
26: int
27: GetComputerNameA
28: ptr
29: CodeIt Plus!
30: struct;byte[
31: ];endstruct
32: struct;byte[54];byte[
33: struct;ptr;ptr;dword;byte[32];endstruct
34: advapi32.dll
35: CryptAcquireContextA
36: dword
37: CryptCreateHash
38: CryptHashData
39: struct*
40: CryptGetHashParam
41: 0x
42: 08020
43: 00010
44: 66000
45: 02000
46: 0000
47: CD4B3
48: 2C650
49: CF21B
50: DA184
51: D8913
52: E6F92
53: 0A37A
54: 4F396
55: 3736C
56: 042C4
57: 59EA0
58: 7B79E
59: A443F
60: FD189
61: 8BAE4
62: 9B115
63: F6CB1
64: E2A7C
65: 1AB3C
66: 4C256
67: 12A51
68: 9035F
69: 18FB3
70: B1752
71: 8B3AE
72: CAF3D
73: 480E9
74: 8BF8A
75: 635DA
76: F974E
77: 00135
78: 35D23
79: 1E4B7
80: 5B2C3
81: 8B804
82: C7AE4
83: D266A
84: 37B36
85: F2C55
86: 5BF3A
87: 9EA6A
88: 58BC8
89: F906C
90: C665E
91: AE2CE
92: 60F2C
93: DE38F
94: D3026
95: 9CC4C
96: E5BB0
97: 90472
98: FF9BD
99: 26F91
100: 19B8C
101: 484FE
102: 69EB9
103: 34F43
104: FEEDE
105: DCEBA
106: 79146
107: 0819F
108: B21F1
109: 0F832
110: B2A5D
111: 4D772
112: DB12C
113: 3BED9
114: 47F6F
115: 706AE
116: 4411A
117: 52
118: struct;ptr;ptr;dword;byte[8192];byte[
119: ];dword;endstruct
120: CryptImportKey
121: CryptDecrypt
122: FLARE
123: ERALF
124: CryptDestroyKey
125: CryptReleaseContext
126: CryptDestroyHash
127: struct;ptr;ptr;dword;byte[16];endstruct
128: struct;dword;dword;dword;dword;dword;byte[128];endstruct
129: GetVersionExA
130: Enter text to encode
131: Can haz code?
132:
133: Help
134: About CodeIt Plus!
135: struct;dword;dword;byte[3918];endstruct
136: int:cdecl
137: justGenerateQRSymbol
138: str
139: justConvertQRSymbolToBitmapPixels
140: This program generates QR codes using QR Code Generator (https://www.nayuki.io/page/qr-code-generator-library) developed by Nayuki.
141: QR Code Generator is available on GitHub (https://github.com/nayuki/QR-Code-generator) and open-sourced under the following permissive MIT License (https://github.com/nayuki/QR-Code-generator#license):
142: Copyright Â© 2020 Project Nayuki. (MIT License)
143: https://www.nayuki.io/page/qr-code-generator-library
144: Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the Software), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
145: 1. The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
146: 2. The Software is provided as is, without warranty of any kind, express or implied, including but not limited to the warranties of merchantability, fitness for a particular purpose and noninfringement. In no event shall the authors or copyright holders be liable for any claim, damages or other liability, whether in an action of contract, tort or otherwise, arising from, out of or in connection with the Software or the use or other dealings in the Software.
147: struct;ushort;endstruct
148: struct;byte;byte;byte;endstruct
149: CreateFile
150: uint
151: SetFilePointer
152: long
153: WriteFile
154: struct;dword;endstruct
155: ReadFile
156: CloseHandle
157: DeleteFileA
158: GetFileSize
</code></pre><p>Using the decoded strings, we can begin to go through the script and rename obfuscated locations.
Inside the main GUI loop, the script passes our input to a third-party DLL that generates the QR code.
It is only after the QR code has already been generated that the flag is added on.</p><pre tabindex=0><code class=language-none data-lang=none>Case $buttonEvent
    Local $input = GUICtrlRead($inputEvent)

    If $input Then
        Local $dllname = LoadEmbeddedFile(26)
        Local $qrstruct = DllStructCreate(&#34;struct;dword;dword;byte[3918];endstruct&#34;)
        Local $fljfojrihf = DllCall($dllname, &#34;int:cdecl&#34;, &#34;justGenerateQRSymbol&#34;, &#34;struct*&#34;, $qrstruct, &#34;str&#34;, $input)

        If $fljfojrihf[0] &lt;&gt; 0 Then
            GenerateFlag($qrstruct)

            Local $somestruct = CreateSomeStruct(
                (DllStructGetData($qrstruct, 1) * DllStructGetData($qrstruct, 2)),  ; width * height
                (DllStructGetData($qrstruct, 1) * DllStructGetData($qrstruct, 2)),  ; width * height
                1024
            )

            $fljfojrihf = DllCall($dllname, &#34;int:cdecl&#34;, &#34;justConvertQRSymbolToBitmapPixels&#34;, &#34;struct*&#34;, $qrstruct, &#34;struct*&#34;, $somestruct[1])
...
</code></pre><p>The <code>GenerateFlag</code> function gets the computer name using <code>GetComputerNameA</code>.
It is then modified in some way by <code>ChangeComputerName</code> before the script hashes it and checks whether it equals the correct hash value.</p><pre tabindex=0><code class=language-none data-lang=none>Func GenerateFlag(ByRef $qrstruct)
    Local $computername = GetComputerName()

    If $computername &lt;&gt; -1 Then
        $computername = Binary(StringLower(BinaryToString($computername)))  ; Computer name must be lowercase ASCII
        Local $computernameraw = DllStructCreate(&#34;struct;byte[&#34; &amp; BinaryLen($computername) &amp; &#34;];endstruct&#34;)

        DllStructSetData($computernameraw, 1, $computername)
        ChangeComputerName($computernameraw)

        Local $flnttmjfea = DllStructCreate(&#34;struct;ptr;ptr;dword;byte[32];endstruct&#34;)
        DllStructSetData($flnttmjfea, 3, 32)

        Local $fluzytjacb = DllCall(&#34;advapi32.dll&#34;, &#34;int&#34;, &#34;CryptAcquireContextA&#34;,
            DECODE($os[$flshmemjjj]), DllStructGetPtr($flnttmjfea, 1),
            DECODE($os[$flhqjglfws]), 0,
            DECODE($os[$flwvzhffsc]), 0,
            DECODE($os[$flfrtkctqe]), 24,
            DECODE($os[$fljhsdaeav]), 4026531840
        )
...
</code></pre><p><code>ChangeComputerName</code> reads the contents of the embedded sprite.bmp file and uses it to add some constants to the calculated computer name.</p><pre tabindex=0><code class=language-none data-lang=none>Func ChangeComputerName(ByRef $computername)
    Local $spritefile = LoadEmbeddedFile(14)
    Local $file = CreateFile2($spritefile)

    If $file &lt;&gt; -1 Then
        Local $filesize = GetFileSize($file)  ; Get size of the sprite file

        If $filesize &lt;&gt; -1 And DllStructGetSize($computername) &lt; $filesize - 54 Then
            ; Read the contents of sprite.bmp into a struct
            Local $bmpdata = DllStructCreate(&#34;struct;byte[&#34; &amp; $filesize &amp; &#34;];endstruct&#34;)
            Local $flskuanqbg = ReadFile($file, $bmpdata)

            If $flskuanqbg &lt;&gt; -1 Then
                ; Break the bmp into header and data fields
                Local $bmp = DllStructCreate(&#34;struct;byte[54];byte[&#34; &amp; $filesize - 54 &amp; &#34;];endstruct&#34;, DllStructGetPtr($bmpdata))
                Local $count = 1
                Local $str = &#34; &#34;

                ; For each char in computer name
                For $i = 1 To DllStructGetSize($computername)
                    ; Number of a binary value
                    Local $c = Number(DllStructGetData($computername, 1, $i))

                    For $j = 6 To 0 Step -1
                        $c += BitShift(BitAND(Number(DllStructGetData($bmp, 2, $count)), 1), -1 * $j)
                        $count += 1
                    Next

                    $str &amp;= Chr(BitShift($c, 1) + BitShift(BitAND($c, 1), -7))
                Next

                ; Change the computer name to whatever str becomes
                DllStructSetData($computername, 1, $str)
            EndIf
        EndIf
        CloseHandle($file)
    EndIf
    DeleteFile($spritefile)
EndFunc   ;==&gt;ChangeComputerName
</code></pre><p>By rewriting this logic in Python, we can check what each constant value is before it is added to the computer name.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># Computer name must be lowercase ASCII</span>
</span></span><span style=display:flex><span>computername <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;a&#34;</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>13</span>
</span></span><span style=display:flex><span>computername <span style=color:#f92672>=</span> computername<span style=color:#f92672>.</span>lower()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;sprite.bmp&#34;</span>, <span style=color:#e6db74>&#34;rb&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()
</span></span><span style=display:flex><span>    filesize <span style=color:#f92672>=</span> len(data)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> len(computername) <span style=color:#f92672>&lt;</span> filesize <span style=color:#f92672>-</span> <span style=color:#ae81ff>54</span>:
</span></span><span style=display:flex><span>        <span style=color:#75715e># Split the BMP by header and data</span>
</span></span><span style=display:flex><span>        header <span style=color:#f92672>=</span> data[:<span style=color:#ae81ff>54</span>]
</span></span><span style=display:flex><span>        data <span style=color:#f92672>=</span> data[<span style=color:#ae81ff>54</span>:]
</span></span><span style=display:flex><span>        count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        outstr <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>0</span>, len(computername)):
</span></span><span style=display:flex><span>            c <span style=color:#f92672>=</span> ord(computername[i])
</span></span><span style=display:flex><span>            origc <span style=color:#f92672>=</span> c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>for</span> j <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>):
</span></span><span style=display:flex><span>                j <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>                b <span style=color:#f92672>=</span> data[count]
</span></span><span style=display:flex><span>                b <span style=color:#f92672>=</span> b <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>1</span>   <span style=color:#75715e># Either 0 or 1</span>
</span></span><span style=display:flex><span>                b <span style=color:#f92672>=</span> b <span style=color:#f92672>&lt;&lt;</span> j  <span style=color:#75715e># Multiples</span>
</span></span><span style=display:flex><span>                c <span style=color:#f92672>+=</span> b
</span></span><span style=display:flex><span>                count <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;Modified by constant: &#34;</span> <span style=color:#f92672>+</span> chr(c <span style=color:#f92672>-</span> origc))
</span></span></code></pre></div><p>Putting the characters together gives us the expected computer name: <code>aut01tfan1999</code>.</p><p>We can now run the program and hook the call to <code>GetComputerNameA</code> with a debugger.
The QR code contains the flag.</p><p><strong>Flag:</strong> <code>L00ks_L1k3_Y0u_D1dnt_Run_Aut0_Tim3_0n_Th1s_0ne!@flare-on.com</code></p></div><footer class=post-footer><div class=post-footer-data><div class=tags><div class=tag><a href=/tags/reversing>#reversing</a></div><div class=tag><a href=/tags/forensics>#forensics</a></div></div><div class=post-footer-meta>Permalink: <a href=https://starfleetcadet75.github.io/posts/flareon-2020-6-codeit/>/posts/flareon-2020-6-codeit/</a> | Date: 2020-09-23</div><hr><div class=categories>Published in:<div class=category><a href=/categories/writeups>writeups</a></div></div><div class=series></div></div></footer></article><footer><div class=social-links-footer><a href=mailto:starfleetcadet75@gmail.com><div class=social-link>Email</div></a><a href=https://github.com/starfleetcadet75 target=_blank><div class=social-link>GitHub</div></a><a href=https://gitlab.com/starfleetcadet75 target=_blank><div class=social-link>GitLab</div></a><div class=social-link><a href=https://starfleetcadet75.github.io/index.xml target=_blank>RSS</a></div></div><div class=copyright></div><div class=poweredby>Powered by <a href=https://gohugo.io/>Hugo</a>.</div></footer></div></body></html>