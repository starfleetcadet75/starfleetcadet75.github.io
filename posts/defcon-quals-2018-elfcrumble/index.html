<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=author content>
<meta name=description content>
<meta name=keywords content>
<meta name=viewport content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name=generator content="Hugo 0.88.1">
<link rel=canonical href=https://starfleetcadet75.github.io/posts/defcon-quals-2018-elfcrumble/>
<meta property="og:title" content="DEFCON CTF Quals 2018: ELF Crumble">
<meta property="og:description" content="For this challenge we start off with a program which is aptly named broken as it segfaults when run.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://starfleetcadet75.github.io/posts/defcon-quals-2018-elfcrumble/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2018-05-18T00:00:00+00:00">
<meta property="article:modified_time" content="2018-05-18T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="DEFCON CTF Quals 2018: ELF Crumble">
<meta name=twitter:description content="For this challenge we start off with a program which is aptly named broken as it segfaults when run.">
<meta itemprop=name content="DEFCON CTF Quals 2018: ELF Crumble">
<meta itemprop=description content="For this challenge we start off with a program which is aptly named broken as it segfaults when run."><meta itemprop=datePublished content="2018-05-18T00:00:00+00:00">
<meta itemprop=dateModified content="2018-05-18T00:00:00+00:00">
<meta itemprop=wordCount content="587">
<meta itemprop=keywords content="reversing,forensics,">
<link rel=stylesheet href=/css/layout.css>
<link rel=stylesheet href=/css/default-dark.css>
<link rel=stylesheet href=/css/adoc-html5-extension.css>
<title>
DEFCON CTF Quals 2018: ELF Crumble
</title>
</head>
<body>
<div class=main>
<header>
<div class=header-bar>
<nav>
<div class=siteTitle>
<a href=https://starfleetcadet75.github.io/>starfleetcadet75</a>
</div>
<a class=nav-item href=/about/><div class=nav-item-title>About</div></a>
<a class=nav-item href=/readinglist/><div class=nav-item-title>Reading List</div></a>
<a class="nav-item active" href=/posts/><div class=nav-item-title>Posts</div></a>
</nav>
<div class=social-links-header style=visibility:hidden;display:none>
<a href=mailto:starfleetcadet75@gmail.com><div class=social-link>email</div></a>
<a href=https://github.com/starfleetcadet75 target=_blank><div class=social-link>gh</div></a>
<a href=https://gitlab.com/starfleetcadet75 target=_blank><div class=social-link>gl</div></a>
</div>
</div>
</header>
<article class=post>
<h1 class=title> DEFCON CTF Quals 2018: ELF Crumble </h1>
<div class=content> <p><strong>Category:</strong> warmup<br>
<strong>Points:</strong> 102<br>
<strong>Provided:</strong></p>
<ul>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/broken>broken</a></li>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/fragment_1.dat>fragment_1.dat</a></li>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/fragment_2.dat>fragment_2.dat</a></li>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/fragment_3.dat>fragment_3.dat</a></li>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/fragment_4.dat>fragment_4.dat</a></li>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/fragment_5.dat>fragment_5.dat</a></li>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/fragment_6.dat>fragment_6.dat</a></li>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/fragment_7.dat>fragment_7.dat</a></li>
<li><a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/fragment_8.dat>fragment_8.dat</a></li>
</ul>
<h2 id=observations>Observations</h2>
<p>For this challenge we start off with a program which is aptly named <code>broken</code> as it segfaults when run. Opening it in Binary Ninja shows us why:</p>
<p><img src=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/original-binary.png alt=original-binary></p>
<p>We notice there are 5 functions <code>main</code>, <code>f1</code>, <code>f2</code>, <code>f3</code>, and <code>recover_flag</code> which have all been replaced with X&rsquo;s.
We are given 8 fragments so its not a 1-1 match for each function. The fragment sizes are as follows:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash> <span style=color:#ae81ff>79</span> fragment_1.dat
 <span style=color:#ae81ff>48</span> fragment_2.dat
<span style=color:#ae81ff>175</span> fragment_3.dat
 <span style=color:#ae81ff>42</span> fragment_4.dat
<span style=color:#ae81ff>128</span> fragment_5.dat
 <span style=color:#ae81ff>22</span> fragment_6.dat
<span style=color:#ae81ff>283</span> fragment_7.dat
 <span style=color:#ae81ff>30</span> fragment_8.dat
</code></pre></div><p>The total size of the fragments adds up to 807 bytes which is also the size of the missing region in the binary.</p>
<h2 id=solution>Solution</h2>
<p>The fragments contain the missing instructions for our binary and we need to put them back in the right places.
This challenge really showed off the great hex editing abilities of Binary Ninja.
I opened up each fragment and started creating user defined functions to disassemble them.
Then I compiled a list of each function fragments size and classified them based on whether they appeared to be function prologues, epilogues, or the main body itself.</p>
<pre tabindex=0><code class=language-none data-lang=none>Fragment 1:
sub_0 = 3 (epilogue)
sub_3 = 69 (complete function)
sub_48 = 7 (prologue)

Fragment 2:
sub_0 = 16 (epilogue)
sub_11 = 31 (prologue)

Fragment 3:
sub_0 = 175 (body)

Fragment 4:
sub_0 = 42 (epilogue)

Fragment 5:
sub_0 = 109 (body and epilogue)
sub_6d = 19 (prologue)

Fragment 6:
sub_0 = 22 (body)

Fragment 7:
sub_0 = 283 (body)

Fragment 8:
sub_0 = 30 (prologue)
</code></pre><p>Then we can calculate the size of each missing function:</p>
<pre tabindex=0><code class=language-none data-lang=none>main: 248
f1: 316
f2: 69
f3: 116
recover_flag: 58
</code></pre><p>Immediately we see that fragment 7 must be part of <code>f1()</code>.
We can also identify that <code>sub_3</code> from fragment 1 must be <code>f2()</code>.</p>
<p><code>sub_0</code> from fragment 3 has the only interesting strings from any of the fragments and very much looks like a main function, so we can conclude that it is part of <code>main()</code>.
This means that we are still missing 73 bytes from <code>main()</code>.
<code>sub_11</code> from fragment 2 is 31 bytes and <code>sub_0</code> from fragment 4 is 42 bytes which together gives us the missing 73 bytes from <code>main()</code>.</p>
<p>Next, we see that <code>sub_6d</code> in fragment 5, fragment 6, and <code>sub_0</code> in fragment 2 adds up to give us the <code>recover_flag()</code> function.</p>
<p>Eventually we end up with the order of the fragments being 8, 7, 1, 5, 6, 2, 3, 4.
After moving the fragments into place using Binary Ninja, we have a <a href=https://github.com/starfleetcadet75/writeups/raw/master/2018-DEFCON-CTF-Quals/broken_fixed>fixed binary</a> that prints the flag when run.</p>
<p><strong>Flag:</strong> <code>welcOOOme</code></p>
<h2 id=the-brute-force-option>The Brute Force Option</h2>
<p>Looking at other writeups online, it seems the common solution was to write a script that tried going through the possible permutations.
One of my teammates did quickly throw together the following script to do just that.
He let it run for quite a while and it did indeed yield the answer, however solving by hand was not that hard and proved to be more enjoyable.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> itertools
<span style=color:#f92672>import</span> subprocess
<span style=color:#f92672>import</span> time
<span style=color:#f92672>import</span> os

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>load</span>(filename):
    <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> f:
      <span style=color:#66d9ef>return</span> f<span style=color:#f92672>.</span>read()

<span style=color:#75715e># 0x5ad 8d3</span>
<span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#39;broken&#39;</span>, <span style=color:#e6db74>&#39;r&#39;</span>) <span style=color:#66d9ef>as</span> f:
    preamble <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>0x5ad</span>)
    f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>807</span>) <span style=color:#75715e># junk</span>
    postamble <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read()

i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
<span style=color:#66d9ef>for</span> xs <span style=color:#f92672>in</span> itertools<span style=color:#f92672>.</span>permutations([<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span>,<span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>7</span>,<span style=color:#ae81ff>8</span>]):
    content <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span><span style=color:#f92672>.</span>join(map(<span style=color:#66d9ef>lambda</span> x: load(<span style=color:#e6db74>&#34;fragment_</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>.dat&#34;</span><span style=color:#f92672>.</span>format(x)), xs))
    filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./brokend/broken</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>&#34;</span><span style=color:#f92672>.</span>format(i)
    <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#34;w&#34;</span>) <span style=color:#66d9ef>as</span> f:
        f<span style=color:#f92672>.</span>write(preamble)
        f<span style=color:#f92672>.</span>write(content)
        f<span style=color:#f92672>.</span>write(postamble)
    os<span style=color:#f92672>.</span>chmod(filename, <span style=color:#ae81ff>0755</span>)
    time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.05</span>)

    brok <span style=color:#f92672>=</span> subprocess<span style=color:#f92672>.</span>Popen([filename], stdout<span style=color:#f92672>=</span>subprocess<span style=color:#f92672>.</span>PIPE, stderr<span style=color:#f92672>=</span>subprocess<span style=color:#f92672>.</span>STDOUT)
    i <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
    response <span style=color:#f92672>=</span> brok<span style=color:#f92672>.</span>stdout<span style=color:#f92672>.</span>read()

    <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> response:
        <span style=color:#66d9ef>continue</span>
    <span style=color:#66d9ef>else</span>:
        print response
</code></pre></div> </div>
<footer class=post-footer>
<div class=post-footer-data>
<div class=tags>
<div class=tag>
<a href=/tags/reversing>#reversing</a>
</div>
<div class=tag>
<a href=/tags/forensics>#forensics</a>
</div>
</div>
<div class=post-footer-meta>Permalink: <a href=https://starfleetcadet75.github.io/posts/defcon-quals-2018-elfcrumble/>/posts/defcon-quals-2018-elfcrumble/</a> | Date: 2018-05-18 </div>
<hr>
<div class=categories>
Published in:
<div class=category>
<a href=/categories/writeups>writeups</a>
</div>
</div>
<div class=series>
</div>
</div>
</footer>
</article>
<footer>
<div class=social-links-footer>
<a href=mailto:starfleetcadet75@gmail.com><div class=social-link>Email</div></a>
<a href=https://github.com/starfleetcadet75 target=_blank><div class=social-link>GitHub</div></a>
<a href=https://gitlab.com/starfleetcadet75 target=_blank><div class=social-link>GitLab</div></a>
<div class=social-link>
<a href=https://starfleetcadet75.github.io/index.xml target=_blank>RSS</a>
</div>
</div>
<div class=copyright> </div>
<div class=poweredby>
Powered by <a href=https://gohugo.io/>Hugo</a>.
</div>
</footer>
</div>
</body>
</html>