<!DOCTYPE html>
<html lang="en-us">

<head>
<meta charset="utf-8" />
<meta name="author" content="" />
<meta name="description" content="" />
<meta name="keywords" content="" />
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="generator" content="Hugo 0.76.2" />

<link rel="canonical" href="https://starfleetcadet75.github.io/posts/cyberstakes-2020-say-what/">
<meta property="og:title" content="Cyberstakes CTF 2020: Say What?" />
<meta property="og:description" content="We intercepted some foreign documents. We think there&rsquo;s interesting information inside but the file is protected with a unique password algorithm" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://starfleetcadet75.github.io/posts/cyberstakes-2020-say-what/" />
<meta property="article:published_time" content="2020-05-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-03T00:00:00+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cyberstakes CTF 2020: Say What?"/>
<meta name="twitter:description" content="We intercepted some foreign documents. We think there&rsquo;s interesting information inside but the file is protected with a unique password algorithm"/>


<meta itemprop="name" content="Cyberstakes CTF 2020: Say What?">
<meta itemprop="description" content="We intercepted some foreign documents. We think there&rsquo;s interesting information inside but the file is protected with a unique password algorithm">
<meta itemprop="datePublished" content="2020-05-03T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-05-03T00:00:00+00:00" />
<meta itemprop="wordCount" content="1496">



<meta itemprop="keywords" content="reversing,forensics,vba," />


<link rel="stylesheet" href="/css/layout.css" />


<link rel="stylesheet" href="/css/default-dark.css" />


<link rel="stylesheet" href="/css/adoc-html5-extension.css" />



<title>


     Cyberstakes CTF 2020: Say What? 

</title>

</head>


<body>
<div class="main">
<header>

<div class="header-bar">

  <nav>
    <div class="siteTitle">
      <a href="https://starfleetcadet75.github.io/">starfleetcadet75</a>
    </div> 

    
    
    <a class="nav-item" href="/about/"><div class="nav-item-title">About</div></a>
    
    <a class="nav-item" href="/readinglist/"><div class="nav-item-title">Reading List</div></a>
    
    <a class="nav-item active" href="/posts/"><div class="nav-item-title">Posts</div></a>
    

  </nav>

  
<div class="social-links-header" style="visibility:hidden; display:none;">

  
  <a href="mailto:starfleetcadet75@gmail.com"><div class="social-link">email</div></a>
  

  
  <a href="https://github.com/starfleetcadet75" target="_blank"><div class="social-link">gh</div></a>
  

  
  <a href="https://gitlab.com/starfleetcadet75" target="_blank"><div class="social-link">gl</div></a>
  

  

  

</div>


</div>


</header>


<article class="post">
    <h1 class="title"> Cyberstakes CTF 2020: Say What? </h1>
    <div class="content"> <p><strong>Category:</strong> Reverse Engineering<br>
<strong>Points:</strong> 200</p>
<h2 id="challenge">Challenge</h2>
<blockquote>
<p>We intercepted some foreign documents.
We think there&rsquo;s interesting information inside but the file is protected with a unique password algorithm: <a href="https://github.com/starfleetcadet75/writeups/blob/master/2020-Cyberstakes/say-what/chall.docm">chall.docm</a></p>
</blockquote>
<h4 id="hints">Hints</h4>
<ul>
<li>Microsoft Office documents sometimes carry with them a powerful set of macros</li>
<li>Microsoft Office is not required to extract the malicious macro, or solve the challenge</li>
<li>There are a number of open source security tooling to script the extraction of Office macros</li>
<li>The macro&rsquo;s obfuscation is rather light, try inserting some MsgBox prints to make sense of what it is doing</li>
<li>If you&rsquo;re not careful, the document might &hellip; change itself.</li>
<li>Double check that your solution works against a &lsquo;fresh&rsquo; copy of the challenge.</li>
</ul>
<h2 id="observations">Observations</h2>
<p>We are provided with a Microsoft Word document that contains a Visual Basic macro.
When we attempt to open the document, the macro executes and prompts us for a password.
Searching for tools to extract VBA macros leads us to this <a href="https://www.decalage.info/vba_tools">post</a>, which points us to <a href="https://github.com/decalage2/oletools">oletools</a>.</p>
<p>Running <code>olevba</code> on the document provides the following output:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vb" data-lang="vb">olevba 0.55.1 <span style="color:#66d9ef">on</span> Python 3.8.2 <span style="color:#f92672">-</span> http:<span style="color:#f92672">//</span>decalage.info<span style="color:#f92672">/</span>python<span style="color:#f92672">/</span>oletools
<span style="color:#f92672">===============================================================================</span>
FILE: chall.docm
Type: OpenXML
<span style="color:#f92672">-------------------------------------------------------------------------------</span>
VBA MACRO ThisDocument.cls
<span style="color:#f92672">in</span> file: word<span style="color:#f92672">/</span>vbaProject.bin <span style="color:#f92672">-</span> OLE stream: <span style="color:#75715e">&#39;VBA/ThisDocument&#39;
</span><span style="color:#75715e"></span><span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span>
<span style="color:#66d9ef">Private</span> <span style="color:#66d9ef">Sub</span> <span style="color:#a6e22e">Document_Open</span>()
    <span style="color:#66d9ef">Call</span> run_unprotect
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Sub</span>
<span style="color:#f92672">-------------------------------------------------------------------------------</span>
VBA MACRO Module1.bas
<span style="color:#f92672">in</span> file: word<span style="color:#f92672">/</span>vbaProject.bin <span style="color:#f92672">-</span> OLE stream: <span style="color:#75715e">&#39;VBA/Module1&#39;
</span><span style="color:#75715e"></span><span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span> <span style="color:#f92672">-</span>
<span style="color:#66d9ef">Public</span> <span style="color:#66d9ef">Const</span> fsagkasiogbiwotiwqoqrvb <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NmgvUlt8glilwTJa1vHPVfuIKUKY/dBIT2DZSlN0004=&#34;</span>

<span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">siooiqbaswtjqiowiasg</span>() <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    siooiqbaswtjqiowiasg <span style="color:#f92672">=</span> ThisDocument.Shapes(3).AlternativeText
    ThisDocument.Shapes(3).AlternativeText <span style="color:#f92672">=</span> fsagkasiogbiwotiwqoqrvb
    Documents.Save NoPrompt:<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, OriginalFormat:<span style="color:#f92672">=</span>wdOriginalDocumentFormat
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>

<span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">klgnagjaskjlbgbsajbsagsajgsa</span>(<span style="color:#66d9ef">ByRef</span> arrData() <span style="color:#f92672">As</span> <span style="color:#66d9ef">Byte</span>) <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    <span style="color:#66d9ef">Dim</span> objXML <span style="color:#f92672">As</span> MSXML2.DOMDocument
    <span style="color:#66d9ef">Dim</span> objNode <span style="color:#f92672">As</span> MSXML2.IXMLDOMElement
    <span style="color:#66d9ef">Set</span> objXML <span style="color:#f92672">=</span> <span style="color:#66d9ef">New</span> MSXML2.DOMDocument
    <span style="color:#66d9ef">Set</span> objNode <span style="color:#f92672">=</span> objXML.createElement(<span style="color:#e6db74">&#34;b64&#34;</span>)
    objNode.dataType <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bin.base64&#34;</span>
    objNode.nodeTypedValue <span style="color:#f92672">=</span> arrData
    klgnagjaskjlbgbsajbsagsajgsa <span style="color:#f92672">=</span> objNode.Text
    <span style="color:#66d9ef">Set</span> objNode <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nothing</span>
    <span style="color:#66d9ef">Set</span> objXML <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nothing</span>
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>

<span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">jisaksgjksbjksabjksabgjskagbjsakgbkj</span>(<span style="color:#66d9ef">ByVal</span> strData <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>) <span style="color:#f92672">As</span> <span style="color:#66d9ef">Byte</span>()
    <span style="color:#66d9ef">Dim</span> objXML <span style="color:#f92672">As</span> MSXML2.DOMDocument
    <span style="color:#66d9ef">Dim</span> objNode <span style="color:#f92672">As</span> MSXML2.IXMLDOMElement
    <span style="color:#66d9ef">Set</span> objXML <span style="color:#f92672">=</span> <span style="color:#66d9ef">New</span> MSXML2.DOMDocument
    <span style="color:#66d9ef">Set</span> objNode <span style="color:#f92672">=</span> objXML.createElement(<span style="color:#e6db74">&#34;b64&#34;</span>)
    objNode.dataType <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bin.base64&#34;</span>
    objNode.Text <span style="color:#f92672">=</span> strData
    jisaksgjksbjksabjksabgjskagbjsakgbkj <span style="color:#f92672">=</span> objNode.nodeTypedValue
    <span style="color:#66d9ef">Set</span> objNode <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nothing</span>
    <span style="color:#66d9ef">Set</span> objXML <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nothing</span>
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>

<span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">jioasgiosahgiosahgsahgbbbbbafsa</span>(<span style="color:#66d9ef">ByVal</span> Text <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>) <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    <span style="color:#66d9ef">Dim</span> gasgasgisogiogioaragba <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>, i <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>
    <span style="color:#66d9ef">For</span> i <span style="color:#f92672">=</span> 0 <span style="color:#66d9ef">To</span> Len(gjasigasogoabvxzbnbkxnzkgas)
        gasgasgisogiogioaragba <span style="color:#f92672">=</span> gasgasgisogiogioaragba <span style="color:#f92672">&amp;</span> Mid(Text, (Length <span style="color:#f92672">-</span> i), 1)
    <span style="color:#66d9ef">Next</span> i
    jioasgiosahgiosahgsahgbbbbbafsa <span style="color:#f92672">=</span> gasgasgisogiogioaragba
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>

<span style="color:#66d9ef">Sub</span> <span style="color:#a6e22e">skagiotiohvasgasgasgassdjjj</span>(<span style="color:#66d9ef">ByRef</span> Text <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>)
    <span style="color:#66d9ef">Dim</span> i <span style="color:#f92672">As</span> <span style="color:#66d9ef">Long</span>
    <span style="color:#66d9ef">For</span> i <span style="color:#f92672">=</span> 1 <span style="color:#66d9ef">To</span> Len(Text)
        Mid<span style="color:#960050;background-color:#1e0010">$</span>(Text, i, 1) <span style="color:#f92672">=</span> Chr<span style="color:#960050;background-color:#1e0010">$</span>(Asc(Mid<span style="color:#960050;background-color:#1e0010">$</span>(Text, i, 1)) <span style="color:#f92672">Xor</span> ((32 <span style="color:#f92672">+</span> i) <span style="color:#f92672">Mod</span> 256))
    <span style="color:#66d9ef">Next</span> i
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Sub</span>

<span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">gdtsrtnbzpsapg</span>(<span style="color:#66d9ef">ByRef</span> gjasigasogoabvxzbnbkxnzkgas <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>) <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    <span style="color:#66d9ef">Dim</span> josajogjsaojpepeqwwqb <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>, kngkasngksagnskarkwta <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>, jifsajgiosthigaohbsb <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>
    <span style="color:#66d9ef">Dim</span> jkasojgoisajgoashrt <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>

    <span style="color:#66d9ef">For</span> i <span style="color:#f92672">=</span> 1 <span style="color:#66d9ef">To</span> Len(gjasigasogoabvxzbnbkxnzkgas)
        josajogjsaojpepeqwwqb <span style="color:#f92672">=</span> ((i <span style="color:#f92672">-</span> 1) <span style="color:#f92672">Mod</span> 4)
        <span style="color:#66d9ef">If</span> josajogjsaojpepeqwwqb <span style="color:#f92672">=</span> 0 <span style="color:#66d9ef">Then</span>
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(gjasigasogoabvxzbnbkxnzkgas, i, 1) <span style="color:#f92672">=</span> Chr<span style="color:#960050;background-color:#1e0010">$</span>(((Asc(Mid(gjasigasogoabvxzbnbkxnzkgas, i, 1)) <span style="color:#f92672">-</span> 104) <span style="color:#f92672">+</span> 256) <span style="color:#f92672">Mod</span> 256)
        <span style="color:#66d9ef">ElseIf</span> josajogjsaojpepeqwwqb <span style="color:#f92672">=</span> 1 <span style="color:#66d9ef">Then</span>
            jkasojgoisajgoashrt <span style="color:#f92672">=</span> Mid(gjasigasogoabvxzbnbkxnzkgas, i, 1)
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(gjasigasogoabvxzbnbkxnzkgas, i, 1) <span style="color:#f92672">=</span> Mid(gjasigasogoabvxzbnbkxnzkgas, i <span style="color:#f92672">-</span> 1, 1)
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(gjasigasogoabvxzbnbkxnzkgas, i <span style="color:#f92672">-</span> 1, 1) <span style="color:#f92672">=</span> jkasojgoisajgoashrt
        <span style="color:#66d9ef">ElseIf</span> josajogjsaojpepeqwwqb <span style="color:#f92672">=</span> 2 <span style="color:#66d9ef">Then</span>
            kngkasngksagnskarkwta <span style="color:#f92672">=</span> (Asc(Mid(gjasigasogoabvxzbnbkxnzkgas, i, 1)) <span style="color:#f92672">*</span> 16) <span style="color:#f92672">Mod</span> 256
            jifsajgiosthigaohbsb <span style="color:#f92672">=</span> Asc(Mid(gjasigasogoabvxzbnbkxnzkgas, i, 1)) <span style="color:#f92672">\</span> 16
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(gjasigasogoabvxzbnbkxnzkgas, i, 1) <span style="color:#f92672">=</span> Chr<span style="color:#960050;background-color:#1e0010">$</span>(kngkasngksagnskarkwta <span style="color:#f92672">+</span> jifsajgiosthigaohbsb)
        <span style="color:#66d9ef">ElseIf</span> josajogjsaojpepeqwwqb <span style="color:#f92672">=</span> 3 <span style="color:#66d9ef">Then</span>
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(gjasigasogoabvxzbnbkxnzkgas, i, 1) <span style="color:#f92672">=</span> Chr<span style="color:#960050;background-color:#1e0010">$</span>(Asc(Mid(gjasigasogoabvxzbnbkxnzkgas, i, 1)) <span style="color:#f92672">Xor</span> Asc(Mid(gjasigasogoabvxzbnbkxnzkgas, i <span style="color:#f92672">-</span> 1, 1)))
        <span style="color:#66d9ef">End</span> <span style="color:#66d9ef">If</span>
    <span style="color:#66d9ef">Next</span> i
    <span style="color:#66d9ef">Call</span> skagiotiohvasgasgasgassdjjj(gjasigasogoabvxzbnbkxnzkgas)
    gdtsrtnbzpsapg <span style="color:#f92672">=</span> StrReverse(gjasigasogoabvxzbnbkxnzkgas)
    gdtsrtnbzpsapg <span style="color:#f92672">=</span> klgnagjaskjlbgbsajbsagsajgsa(StrConv(gdtsrtnbzpsapg, vbFromUnicode))

<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>

<span style="color:#66d9ef">Sub</span> <span style="color:#a6e22e">run_unprotect</span>()
    <span style="color:#66d9ef">Dim</span> gjasigasogoabvxzbnbkxnzkgas <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    <span style="color:#66d9ef">Dim</span> jisajgoajgosajohnnvvnv <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    <span style="color:#66d9ef">Dim</span> tietojosapgjpsaje <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    gjasigasogoabvxzbnbkxnzkgas <span style="color:#f92672">=</span> InputBox(<span style="color:#e6db74">&#34;Enter document password:&#34;</span>, <span style="color:#e6db74">&#34;File Decryption&#34;</span>)
    <span style="color:#66d9ef">If</span> gjasigasogoabvxzbnbkxnzkgas <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#66d9ef">Then</span>
        MsgBox (<span style="color:#e6db74">&#34;No password provided...&#34;</span>)
        <span style="color:#66d9ef">Exit</span> <span style="color:#66d9ef">Sub</span>
    <span style="color:#a6e22e">End</span> <span style="color:#66d9ef">If</span>
    jisajgoajgosajohnnvvnv <span style="color:#f92672">=</span> gdtsrtnbzpsapg(gjasigasogoabvxzbnbkxnzkgas)
    tietojosapgjpsaje <span style="color:#f92672">=</span> siooiqbaswtjqiowiasg()
    <span style="color:#66d9ef">If</span> (jisajgoajgosajohnnvvnv <span style="color:#f92672">=</span> tietojosapgjpsaje) <span style="color:#f92672">And</span> (jisajgoajgosajohnnvvnv <span style="color:#f92672">&lt;&gt;</span> fsagkasiogbiwotiwqoqrvb) <span style="color:#66d9ef">Then</span>
        MsgBox (<span style="color:#e6db74">&#34;Password accepted!&#34;</span>)
    <span style="color:#66d9ef">Else</span>
        MsgBox (<span style="color:#e6db74">&#34;Incorrect password...&#34;</span>)
    <span style="color:#66d9ef">End</span> <span style="color:#66d9ef">If</span>
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Sub</span>
<span style="color:#f92672">+----------+--------------------+---------------------------------------------+</span>
<span style="color:#960050;background-color:#1e0010">|</span>Type      <span style="color:#960050;background-color:#1e0010">|</span>Keyword             <span style="color:#960050;background-color:#1e0010">|</span>Description                                  <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#f92672">+----------+--------------------+---------------------------------------------+</span>
<span style="color:#960050;background-color:#1e0010">|</span>AutoExec  <span style="color:#960050;background-color:#1e0010">|</span>Document_Open       <span style="color:#960050;background-color:#1e0010">|</span>Runs <span style="color:#66d9ef">when</span> the Word <span style="color:#f92672">or</span> Publisher document <span style="color:#f92672">is</span>  <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>          <span style="color:#960050;background-color:#1e0010">|</span>                    <span style="color:#960050;background-color:#1e0010">|</span>opened                                       <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>Suspicious<span style="color:#960050;background-color:#1e0010">|</span><span style="color:#66d9ef">Call</span>                <span style="color:#960050;background-color:#1e0010">|</span>May <span style="color:#66d9ef">call</span> a DLL <span style="color:#66d9ef">using</span> Excel 4 Macros (XLM<span style="color:#f92672">/</span>XLF)<span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>Suspicious<span style="color:#960050;background-color:#1e0010">|</span>Chr                 <span style="color:#960050;background-color:#1e0010">|</span>May attempt <span style="color:#66d9ef">to</span> obfuscate specific strings    <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>          <span style="color:#960050;background-color:#1e0010">|</span>                    <span style="color:#960050;background-color:#1e0010">|</span>(use <span style="color:#66d9ef">option</span> <span style="color:#f92672">--</span>deobf <span style="color:#66d9ef">to</span> deobfuscate)          <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>Suspicious<span style="color:#960050;background-color:#1e0010">|</span>StrReverse          <span style="color:#960050;background-color:#1e0010">|</span>May attempt <span style="color:#66d9ef">to</span> obfuscate specific strings    <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>          <span style="color:#960050;background-color:#1e0010">|</span>                    <span style="color:#960050;background-color:#1e0010">|</span>(use <span style="color:#66d9ef">option</span> <span style="color:#f92672">--</span>deobf <span style="color:#66d9ef">to</span> deobfuscate)          <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>Suspicious<span style="color:#960050;background-color:#1e0010">|</span><span style="color:#f92672">Xor</span>                 <span style="color:#960050;background-color:#1e0010">|</span>May attempt <span style="color:#66d9ef">to</span> obfuscate specific strings    <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>          <span style="color:#960050;background-color:#1e0010">|</span>                    <span style="color:#960050;background-color:#1e0010">|</span>(use <span style="color:#66d9ef">option</span> <span style="color:#f92672">--</span>deobf <span style="color:#66d9ef">to</span> deobfuscate)          <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>Suspicious<span style="color:#960050;background-color:#1e0010">|</span>Base64 Strings      <span style="color:#960050;background-color:#1e0010">|</span>Base64<span style="color:#f92672">-</span>encoded strings were detected, may be <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>          <span style="color:#960050;background-color:#1e0010">|</span>                    <span style="color:#960050;background-color:#1e0010">|</span>used <span style="color:#66d9ef">to</span> obfuscate strings (<span style="color:#66d9ef">option</span> <span style="color:#f92672">--</span>decode <span style="color:#66d9ef">to</span><span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#960050;background-color:#1e0010">|</span>          <span style="color:#960050;background-color:#1e0010">|</span>                    <span style="color:#960050;background-color:#1e0010">|</span>see all)                                     <span style="color:#960050;background-color:#1e0010">|</span>
<span style="color:#f92672">+----------+--------------------+---------------------------------------------+</span>
</code></pre></div><p>The macro seems to have been lightly obfuscated by renaming all of the variables to meaningless names.</p>
<h2 id="solution">Solution</h2>
<p>We can dump the contents of the macro to a file and start to rename the variables based on their usage.
There is a base64 value at the beginning that is assigned to a variable called flag.
Unfortunately, base64 decoding it only gives us the encoded bytes.
The first function is called <code>GetPassword</code> and reads a value from <code>ThisDocument.Shapes(3).AlternativeText</code>.
This seems to imply that one of the shapes in the document contains the password.
Looking at the alternative text for the padlock image, we can see a base64 value which contains the password we need to enter:</p>
<p><img src="https://raw.githubusercontent.com/starfleetcadet75/writeups/master/2020-Cyberstakes/say-what/alttext.png" alt="alttext.png"></p>
<p>The cleaned up version of the macro appears as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-vb" data-lang="vb"><span style="color:#66d9ef">Const</span> flag <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NmgvUlt8glilwTJa1vHPVfuIKUKY/dBIT2DZSlN0004=&#34;</span>

<span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">GetPassword</span>() <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    GetPassword <span style="color:#f92672">=</span> ThisDocument.Shapes(3).AlternativeText
    ThisDocument.Shapes(3).AlternativeText <span style="color:#f92672">=</span> flag
    Documents.Save NoPrompt:<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, OriginalFormat:<span style="color:#f92672">=</span>wdOriginalDocumentFormat
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>

<span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">encodeBase64</span>(<span style="color:#66d9ef">ByRef</span> arrData() <span style="color:#f92672">As</span> <span style="color:#66d9ef">Byte</span>) <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    ... snip ...
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>

<span style="color:#66d9ef">Sub</span> <span style="color:#a6e22e">XorFunction</span>(<span style="color:#66d9ef">ByRef</span> Text <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>)
    <span style="color:#66d9ef">Dim</span> i <span style="color:#f92672">As</span> <span style="color:#66d9ef">Long</span>
    <span style="color:#66d9ef">For</span> i <span style="color:#f92672">=</span> 1 <span style="color:#66d9ef">To</span> Len(Text)
        Mid<span style="color:#960050;background-color:#1e0010">$</span>(Text, i, 1) <span style="color:#f92672">=</span> Chr<span style="color:#960050;background-color:#1e0010">$</span>(Asc(Mid<span style="color:#960050;background-color:#1e0010">$</span>(Text, i, 1)) <span style="color:#f92672">Xor</span> ((32 <span style="color:#f92672">+</span> i) <span style="color:#f92672">Mod</span> 256))
    <span style="color:#66d9ef">Next</span> i
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Sub</span>

<span style="color:#66d9ef">Function</span> <span style="color:#a6e22e">HashInput</span>(<span style="color:#66d9ef">ByRef</span> guess <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>) <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    <span style="color:#66d9ef">Dim</span> x <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>, y <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>, z <span style="color:#f92672">As</span> <span style="color:#66d9ef">Integer</span>
    <span style="color:#66d9ef">Dim</span> s <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>

    <span style="color:#66d9ef">For</span> i <span style="color:#f92672">=</span> 1 <span style="color:#66d9ef">To</span> Len(guess)
        x <span style="color:#f92672">=</span> ((i <span style="color:#f92672">-</span> 1) <span style="color:#f92672">Mod</span> 4)
        <span style="color:#66d9ef">If</span> x <span style="color:#f92672">=</span> 0 <span style="color:#66d9ef">Then</span>
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(guess, i, 1) <span style="color:#f92672">=</span> Chr<span style="color:#960050;background-color:#1e0010">$</span>(((Asc(Mid(guess, i, 1)) <span style="color:#f92672">-</span> 104) <span style="color:#f92672">+</span> 256) <span style="color:#f92672">Mod</span> 256)

        <span style="color:#66d9ef">ElseIf</span> x <span style="color:#f92672">=</span> 1 <span style="color:#66d9ef">Then</span>
            s <span style="color:#f92672">=</span> Mid(guess, i, 1)
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(guess, i, 1) <span style="color:#f92672">=</span> Mid(guess, i <span style="color:#f92672">-</span> 1, 1)
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(guess, i <span style="color:#f92672">-</span> 1, 1) <span style="color:#f92672">=</span> s

        <span style="color:#66d9ef">ElseIf</span> x <span style="color:#f92672">=</span> 2 <span style="color:#66d9ef">Then</span>
            y <span style="color:#f92672">=</span> (Asc(Mid(guess, i, 1)) <span style="color:#f92672">*</span> 16) <span style="color:#f92672">Mod</span> 256
            z <span style="color:#f92672">=</span> Asc(Mid(guess, i, 1)) <span style="color:#f92672">\</span> 16
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(guess, i, 1) <span style="color:#f92672">=</span> Chr<span style="color:#960050;background-color:#1e0010">$</span>(y <span style="color:#f92672">+</span> z)

        <span style="color:#66d9ef">ElseIf</span> x <span style="color:#f92672">=</span> 3 <span style="color:#66d9ef">Then</span>
            Mid<span style="color:#960050;background-color:#1e0010">$</span>(guess, i, 1) <span style="color:#f92672">=</span> Chr<span style="color:#960050;background-color:#1e0010">$</span>(Asc(Mid(guess, i, 1)) <span style="color:#f92672">Xor</span> Asc(Mid(guess, i <span style="color:#f92672">-</span> 1, 1)))

        <span style="color:#66d9ef">End</span> <span style="color:#66d9ef">If</span>
    <span style="color:#66d9ef">Next</span> i

    <span style="color:#66d9ef">Call</span> XorFunction(guess)
    HashInput <span style="color:#f92672">=</span> StrReverse(guess)
    HashInput <span style="color:#f92672">=</span> encodeBase64(StrConv(HashInput, vbFromUnicode))
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Function</span>

<span style="color:#66d9ef">Sub</span> <span style="color:#a6e22e">run_unprotect</span>()
    <span style="color:#66d9ef">Dim</span> guess <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    <span style="color:#66d9ef">Dim</span> encodedInput <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>
    <span style="color:#66d9ef">Dim</span> password <span style="color:#f92672">As</span> <span style="color:#66d9ef">String</span>

    guess <span style="color:#f92672">=</span> InputBox(<span style="color:#e6db74">&#34;Enter document password:&#34;</span>, <span style="color:#e6db74">&#34;File Decryption&#34;</span>)
    <span style="color:#66d9ef">If</span> guess <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#66d9ef">Then</span>
        MsgBox (<span style="color:#e6db74">&#34;No password provided...&#34;</span>)
        <span style="color:#66d9ef">Exit</span> <span style="color:#66d9ef">Sub</span>
    <span style="color:#a6e22e">End</span> <span style="color:#66d9ef">If</span>

    encodedInput <span style="color:#f92672">=</span> HashInput(guess)
    password <span style="color:#f92672">=</span> GetPassword()
    <span style="color:#66d9ef">If</span> (encodedInput <span style="color:#f92672">=</span> password) <span style="color:#f92672">And</span> (encodedInput <span style="color:#f92672">&lt;&gt;</span> flag) <span style="color:#66d9ef">Then</span>
        MsgBox (<span style="color:#e6db74">&#34;Password accepted!&#34;</span>)
    <span style="color:#66d9ef">Else</span>
        MsgBox (<span style="color:#e6db74">&#34;Incorrect password...&#34;</span>)
    <span style="color:#66d9ef">End</span> <span style="color:#66d9ef">If</span>
<span style="color:#66d9ef">End</span> <span style="color:#66d9ef">Sub</span>
</code></pre></div><p>The entered guess is passed to a function that encodes it and the result is compared against the encoded password.
The encoding function operates on four characters at a time, performing a different operation on each one.</p>
<ol>
<li>The first character is incremented by a value modulo 256 to ensure that it stays within the size of a byte</li>
<li>The second character is swapped with the first character</li>
<li>The third character is multiplied and then divided by some value</li>
<li>The fourth character is xored with the third character</li>
</ol>
<p>After the individual character operations are completed, every character is xored by 32 plus its position.
The input is then reversed and base64 encoded.</p>
<p>All of the encoding operations are invertible, which means that we can write a script that will perform the same operations in reverse to recover the password.
For our purposes, the <code>Mid</code> operation is equivalent to accessing the current element from an array.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> binascii
<span style="color:#f92672">import</span> string
<span style="color:#f92672">import</span> base64

<span style="color:#75715e"># Base64 decode the pasword and undo the reversing of the bytes</span>
password <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;e3n3WxMt9w5Hcf0GE3XOCSMM/k4vHeIYg7ToHMu3+2I=&#34;</span>
password <span style="color:#f92672">=</span> bytearray(base64<span style="color:#f92672">.</span>b64decode(password)[::<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])

<span style="color:#75715e"># Xor is invertible by xoring with itself, so we copy the original function</span>
<span style="color:#75715e"># Take note of the zero-based indexing here versus in the macro itself</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, len(password)):
    password[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> password[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> ((<span style="color:#ae81ff">32</span> <span style="color:#f92672">+</span> i) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>)

<span style="color:#75715e"># Undo the individual character encodings</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(password)):
    x <span style="color:#f92672">=</span> i <span style="color:#f92672">%</span> <span style="color:#ae81ff">4</span>

    <span style="color:#66d9ef">if</span> x <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
        <span style="color:#75715e"># Reswap the first and second characters</span>
        m <span style="color:#f92672">=</span> password[i]
        password[i] <span style="color:#f92672">=</span> password[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>]
        password[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> m

        <span style="color:#75715e"># Flipping the minus sign inverts the increment operation on the first character</span>
        password[i] <span style="color:#f92672">=</span> ((password[i] <span style="color:#f92672">+</span> <span style="color:#ae81ff">104</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">256</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span>

    <span style="color:#66d9ef">elif</span> x <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>:
        <span style="color:#75715e"># Reverse the xor first before inverting the previous character</span>
        password[i] <span style="color:#f92672">=</span> password[i] <span style="color:#f92672">^</span> password[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]

        <span style="color:#75715e"># The multiply / divide operation is invertible by being repeated on the character</span>
        password[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> (password[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">%</span> <span style="color:#ae81ff">256</span> <span style="color:#f92672">+</span> int(password[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">16</span>)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Decoded: {}&#34;</span><span style="color:#f92672">.</span>format(password))
</code></pre></div><p><strong>Flag:</strong> <code>ACI{699801c58c20d8da33d957a91fd}</code></p>
 </div>
    <footer class="post-footer">

  <div class="post-footer-data">
            
<div class="tags">
  
    
      <div class="tag">
        <a href="/tags/reversing">#reversing</a>
      </div>
    
      <div class="tag">
        <a href="/tags/forensics">#forensics</a>
      </div>
    
      <div class="tag">
        <a href="/tags/vba">#vba</a>
      </div>
    
  
</div>

    <div class="post-footer-meta">Permalink: <a href="https://starfleetcadet75.github.io/posts/cyberstakes-2020-say-what/">/posts/cyberstakes-2020-say-what/</a> | Date: 2020-05-03 </div>
    
    <hr>
            
<div class="categories">
  
  Published in:
    
      <div class="category">
        <a href="/categories/writeups">writeups</a>
      </div>
    
  
</div>

            
<div class="series">
  
</div>

    
  </div>
</footer>



</article>

  <footer>

  <div class="social-links-footer">

  
  <a href="mailto:starfleetcadet75@gmail.com"><div class="social-link">Email</div></a>
  

  
  <a href="https://github.com/starfleetcadet75" target="_blank"><div class="social-link">GitHub</div></a>
  

  
  <a href="https://gitlab.com/starfleetcadet75" target="_blank"><div class="social-link">GitLab</div></a>
  

  

  

  <div class="social-link">
  <a href="https://starfleetcadet75.github.io/index.xml" target="_blank">RSS</a>
  </div>

</div>


  <div class="copyright">  </div>

  <div class="poweredby">
    Powered by <a href="https://gohugo.io/">Hugo</a>.
  </div>

  </footer>

</div> 

</body>
</html>

